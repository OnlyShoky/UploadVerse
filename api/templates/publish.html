{% extends "base.html" %}

{% block title %}Publish Video - UploadVerse{% endblock %}

{% block content %}
<div class="publish-page">
    <div class="container">
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step completed">
                <div class="step-icon">✓</div>
                <span>Upload</span>
            </div>
            <div class="step completed">
                <div class="step-icon">✓</div>
                <span>Configure</span>
            </div>
            <div class="step active">
                <div class="step-icon">3</div>
                <span>Publish</span>
            </div>
        </div>

        <div class="publish-grid">
            <!-- Review Summary -->
            <div class="review-section">
                <h2 class="section-title">Review</h2>

                <div class="review-card">
                    <h3 class="card-title">Video</h3>
                    <p class="card-text">{{ upload.filename }}</p>
                    <p class="card-meta">{{ upload.video_meta.width }}x{{ upload.video_meta.height }} · {{
                        upload.video_meta.format }}</p>
                </div>

                <div class="review-card">
                    <h3 class="card-title">Platforms</h3>
                    <div class="platform-list">
                        {% for platform in upload.platforms %}
                        <span class="badge badge-primary">{{ platform }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="review-card">
                    <h3 class="card-title">Metadata</h3>
                    <dl class="metadata-list">
                        {% if upload.metadata.title %}
                        <dt>Title:</dt>
                        <dd>{{ upload.metadata.title }}</dd>
                        {% endif %}

                        <h2 class="section-title">Ready to Publish?</h2>

                        <div class="publish-card">
                            <p class="publish-message">Your video will be uploaded to the selected platforms. This
                                process may
                                take several minutes.</p>

                            <div id="publish-status" style="display: none;">
                                <!-- Progress Bar -->
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                                </div>
                                <p class="progress-text" id="progress-text">Starting upload...</p>
                            </div>

                            <div id="publish-results" style="display: none;">
                                <!-- Results will be inserted here -->
                            </div>

                            <div class="publish-actions" id="publish-actions">
                                <button type="button" class="btn btn-primary btn-large" id="publish-btn"
                                    onclick="publishVideo('{{ upload.file_id }}')">
                                    Publish Now
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M5 12h14"></path>
                                        <path d="M12 5l7 7-7 7"></path>
                                    </svg>
                                </button>

                                <a href="{{ url_for('web.config', file_id=upload.file_id) }}"
                                    class="btn btn-secondary">Back to
                                    Edit</a>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function publishVideo(fileId) {
            const publishBtn = document.getElementById('publish-btn');
            const publishActions = document.getElementById('publish-actions');
            const publishStatus = document.getElementById('publish-status');
            const publishResults = document.getElementById('publish-results');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');

            // Disable button
            publishBtn.disabled = true;
            publishStatus.style.display = 'block';

            // Simulate progress (in real app, poll /api/progress/<job_id>)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress <= 90) {
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Uploading... ${progress}%`;
                }
            }, 500);

            try {
                const response = await fetch(`/publish/${fileId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressText.textContent = 'Upload complete!';

                // Show results
                setTimeout(() => {
                    publishStatus.style.display = 'none';
                    publishResults.style.display = 'block';

                    if (data.status === 'success') {
                        let resultsHTML = '<div class="results-success"><h3>✅ Success!</h3><div class="results-list">';

                        data.results.forEach(result => {
                            if (result.success) {
                                resultsHTML += `
                            <div class="result-item success">
                                <strong>${result.platform}</strong>
                                <a href="${result.url}" target="_blank" class="result-link">View Video →</a>
                            </div>
                        `;
                            } else {
                                resultsHTML += `
                            <div class="result-item error">
                                <strong>${result.platform}</strong>
                                <span class="error-text">${result.error}</span>
                            </div>
                        `;
                            }
                        });

                        resultsHTML += '</div><a href="/" class="btn btn-primary">Upload Another Video</a></div>';
                        publishResults.innerHTML = resultsHTML;
                    } else {
                        publishResults.innerHTML = `
                    <div class="results-error">
                        <h3>❌ Upload Failed</h3>
                        <p>${data.error}</p>
                        <button onclick="location.reload()" class="btn btn-secondary">Try Again</button>
                    </div>
                `;
                    }
                }, 1000);

            } catch (error) {
                clearInterval(progressInterval);
                publishResults.innerHTML = `
            <div class="results-error">
                <h3>❌ Error</h3>
                <p>${error.message}</p>
                <button onclick="location.reload()" class="btn btn-secondary">Try Again</button>
            </div>
        `;
                publishStatus.style.display = 'none';
                publishResults.style.display = 'block';
            }
        }
    </script>
    {% endblock %}